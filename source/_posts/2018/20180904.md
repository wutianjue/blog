---
title: Jvm规范之Jvm结构
date: 2018-09-04 09:38:22
tags:
- Jvm
---
在Jvm规范的{% link 第二章 https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-2.html %}中为我们详细介绍了Jvm的抽象结构，Jvm的主要职责是读取字节码文件并正确运行其中的指令。那么运行的状态究竟时什么样的？本文将会介绍一二。
<!-- more -->
# Jvm中的数据类型
Jvm与Java编程语言一样只具有两种数据类型：基本类型，引用类型。
- 基本类型中有又分为整型：byte、short、int、long、char；浮点型：float和double，另外还有boolean和returnAddress。Jvm中并没有专门为boolean设计的指令因此对boolean的支持有限，boolean在实际运行中是以int类型来替代的，0表示false1表示true。returnAddress类型的值是指向Java虚拟机指令操作码的指针，作为一种Jvm中独有数据类型Java编程中并不能直接处理它。
- 引用类型有三种：类类型，数组类型和接口类型。数组类型的元素类型必须是基本类型，类类型或接口类型。引用类型的默认值是null。

# 运行时的数据区域
Java虚拟机定义了在程序执行期间使用的各种运行时数据区域，其中一些数据区域是在Java虚拟机启动时创建的，仅在Java虚拟机退出时销毁，其他的是各自的线程数据区域，线程数据区域伴随线程的创建而创建销毁而销毁。为了更为直观的了解Jvm运行时的数据区域，我附上了一张示例图。
{% asset_img jvm_memory_overview.jpg 示例图 %}
## 线程区域
pc（程序计数器）寄存器属于线程的数据区域。在任意时刻一个线程只会正在执行一个方法，pc寄存器则会包含当前正在执行的Java虚拟机指令的地址。如果执行的是native方法，那么pc寄存器的值将不会被定义。
栈每个线程在创建时都同时创建一个私有的栈区域，栈区域中包含多个帧，因此在详细介绍栈之前我们需要了解帧是什么。
帧用于存储数据和部分结果，以及执行动态链接，返回方法的值以及调度异常，相应的它具有三个重要的组成：局部变量、操作数栈和对常量池数据的引用。线程中每次调用方法时都会创建一个新帧，当方法调用完成时被销毁。并将控制转移到之前的帧。
介绍完帧之后我们再来看看栈，栈区域包含各个帧，由于任意时刻单个线程只会执行一个方法，正在运行的帧称为栈的当前帧。
## 堆
堆是运行时数据区，从中分配所有类实例和数组的内存，并被所有线程所共享使用。在Jvm启动时堆就会被创建，由于堆中对象不会被显示的释放所以需要由垃圾回收器来处理。堆的内存区域不是连续的，而且大小是可以设置的，设置为固定大小或者是动态调整的。如果堆被已全部使用，在分配新的内存区域时Jvm会抛出OutOfMemoryError的错误。
## 方法区域
方法区域类似于编译代码的存储区域或类似于操作系统进程中的“文本”段。它存储各个类的结构，例如运行时常量池，字段和方法信息，包括方法和构造函数的代码，类和实例初始化以及接口初始化中使用的特殊方法。方法区域在Jvm启动时创建，在逻辑上是堆的一部分，但是一般的垃圾回收并不会处理它。与堆类似它的大小时可以设置为固定或是动态调整的。当方法区域无法为新的请求分配内存区域时Jvm会抛出OutOfMemoryError的错误。
## 常量池区域
运行时常量池是类文件中constant_pool表的数据存储。它包含几种常量，从编译时已知的数字文字到必须在运行时解析的方法和字段引用。运行时常量池为帧的运行提供类似于导航辅助的功能。每个运行时常量池都是从Java虚拟机的方法区域中分配的。当Java虚拟机创建类或接口时，就会相应的创建对应的常量池。当方法区域无法为新的类或接口分配常量池内存时Jvm会抛出OutOfMemoryError的错误。
## 本地方法栈
Jvm可以使用常规堆栈（俗称“C堆栈”）来支持本地方法。本机方法堆栈也可以由用于Java虚拟机的指令集的解释器的实现来使用，例如C语言。无法加载本机方法且本身不依赖于传统堆栈的Java虚拟机实现无需提供本机方法堆栈。如果提供，则通常在创建每个线程时为每个线程分配本机方法堆栈。本机方法堆栈具有固定大小或根据计算的需要动态调整。如果线程中的计算需要比允许的本机方法堆栈更大，则Java虚拟机会抛出StackOverflowError。如果可以使内存不足以为新线程创建初始本机方法堆栈，则Java虚拟机会抛出OutOfMemoryError。
# 写在最后
在第二章中介绍了其他内容，例如：介绍下指令的种类、方法的正常结束和突然结束等等，由于篇幅有限，此处略过，有兴趣的同学可以去官网学习研究。
